from statistics import mean, stdev
import os
import sys
import getopt

###PSUEDO###

###/PSUEDO###


def setThresh(inDir, outFile):
    rates = []
    for fn in os.listdir(inDir):
        for line in open(inDir+fn,'r'):
            rate = float(line.split(',')[7])
            rates.append(rate)

    #thresh = mean(rates)+stdev(rates)*2
    thresh = 1000
    outFile.write("Overall Average: %f\n" % mean(rates))
    outFile.write("Standard Deviation: %f\n" % stdev(rates))
    outFile.write("Threshold set to: %f\n" % thresh)
    return thresh

def overThresh(inDir, outFile, thresh):
    total = 0.0
    overThresh = 0.0
    for fn in os.listdir(inDir):
        for line in open(inDir+fn,'r'):
            rate = float(line.split(',')[7])
            total+=1
            if float(rate) > thresh:
                outFile.write(line)
                overThresh+=1

    outFile.write("Percentage over threshold: %f\n" % (overThresh/total))

    
def threshTeam(csvPath, outFile, team):
    
    print("** Analyzing thresholds for team %s ** " % team)
    outFile.write("*** %s ***\n" % team)
    
    ## Input Dir
    inDir = os.getcwd() + '/' + csvPath + '/'
    if not os.path.isdir(inDir):
        print("Error: skipping directory %s" % inDir)
        return
    print("Input directory: " + inDir)

    thresh = setThresh(inDir, outFile)
    print("Thresh = %f" % thresh)
    overThresh(inDir, outFile, thresh)
    
    outFile.write("\n\n")
    print


def histoDay(csvPath,outFile):
    for fn in os.listdir(os.getcwd()+csvPath):
        threshTeam(csvPath+'/'+fn, outFile, fn)

    
def histoDEFCON(csvPath):
    ## Output Dir
    outDir = os.getcwd() + '/results/' + csvPath[6:] + '/'
    print("Output file: " + outDir)
    print("Making output directory...")
    try: os.makedirs(outDir)
    except(OSError): print("Directory exists")

    csvPath += '/pcaps/'
    
    for fn in os.listdir(os.getcwd()+csvPath):
        outfn = outDir+'/'+fn+'-histo.csv'
        print("Making output file: %s" % outfn)
        outFile = open(outfn, 'w')
        threshDay(csvPath+'/'+fn, outFile)


def main(argv):
    
    if len(argv) is not 1:
       print("Usage: python makeFlow.py <DEFCON name>")
       sys.exit(1)
    else:
        csvPath = '/csvs/' + argv[0] + '/'
        histoDEFCON(csvPath)
        #threshDay(csvPath)
        #makeCSVTeam(silkPath



if __name__ == "__main__":
    main(sys.argv[1:])
